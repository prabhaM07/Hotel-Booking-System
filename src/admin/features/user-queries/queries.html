<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>User Queries - Zyra Hotel Booking System</title>
  <!-- Keep existing CDNs as provided -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="module" src="https://cdn.jsdelivr.net/npm/ldrs/dist/auto/dotSpinner.js"></script>

  <style>
    .border-primary { border-color: #2563EB; }
    .border-secondary { border-color: #64748B; }
    .border-accent { border-color: #059669; }
    .bg-primary { background-color: #2563EB; }
    .bg-secondary { background-color: #64748B; }
    .bg-accent { background-color: #059669; }
    .text-primary { color: #2563EB; }
    .text-secondary { color: #64748B; }
    .text-accent { color: #059669; }
    .hover\:bg-primary:hover { background-color: #1D4ED8; }
    .hover\:bg-secondary:hover { background-color: #475569; }
    .hover\:bg-accent:hover { background-color: #047857; }
    .hover\:border-primary:hover { border-color: #2563EB; }
    .hover\:border-secondary:hover { border-color: #64748B; }
    .focus\:ring-primary:focus { --tw-ring-color: #2563EB; }
    .focus\:border-primary:focus { border-color: #2563EB; }
    .bg-professional-gradient {
      background: linear-gradient(135deg, #1E40AF 0%, #3730A3 50%, #5B21B6 100%);
    }
    .relative { position: relative; }
    #filtersDropdown { animation: slideDown 0.2s ease-out; }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .line-clamp-2 {
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .pagination-button { transition: all 0.2s ease; }
    .pagination-button:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
    }
    .pagination-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      transform: none;
    }
    .professional-shadow {
      box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
    }
    .professional-shadow-lg {
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
  </style>
</head>
<body class="m-0 p-0 bg-gray-50">
  <!-- Mobile Overlay -->
  <div id="overlay" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden"></div>

  <!-- External Toggle Button -->
  <button id="externalToggle" class="fixed top-4 left-4 z-50 p-2 bg-white text-gray-600 rounded-lg professional-shadow-lg hover:shadow-xl hover:bg-gray-50 transition-all duration-300 hidden border border-gray-200">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
    </svg>
  </button>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 left-0 w-80 h-full bg-[#1D1354] text-white flex flex-col transform transition-transform duration-300 z-50 overflow-hidden">
    <div class="flex items-center justify-between p-4 h-16 border-b border-[#2E1B8C] relative">
      <h2 class="text-2xl lg:text-3xl font-extrabold bg-gradient-to-r from-orange-400 via-red-500 to-pink-600 bg-clip-text text-transparent">Zyra</h2>
      <button id="sidebarToggle" class="hover:bg-[#2E1B8C] p-2 rounded transition-all duration-300 relative z-10">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
        </svg>
      </button>
    </div>

    <nav class="flex-1 px-4 py-6 space-y-2 text-sm overflow-y-hidden">
      <a href="/src/admin/features/dashboard/dashboard.html" class="block px-3 py-3 rounded-md hover:bg-[#2E1B8C] font-semibold text-lg">Dashboard</a>
      <div>
        <button id="bookingToggle" class="flex items-center justify-between w-full px-3 py-3 rounded-md hover:bg-[#2E1B8C] transition-colors">
          <span class="font-semibold text-lg">Booking</span>
          <svg id="bookingArrow" xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
          </svg>
        </button>
        <div id="bookingSubmenu" class="ml-4 mt-2 space-y-1 overflow-hidden transition-all duration-300" style="max-height: 0px">
          <a href="/src/admin/features/booking/refund-Booking.html" class="block px-3 py-2 hover:bg-[#2E1B8C] rounded-md transition-colors font-semibold">Refund Bookings</a>
          <a href="/src/admin/features/booking/bookingRecords.html" class="block px-3 py-2 hover:bg-[#2E1B8C] rounded-md transition-colors font-semibold">Booking Records</a>
        </div>
      </div>
      <a href="/src/admin/features/rooms/rooms.html" id="rooms" class="block px-3 py-3 hover:bg-[#2E1B8C] rounded-md font-semibold text-lg transition-colors">Rooms</a>
      <a href="/src/admin/features/ratings-reviews/reviews-ratings.html" id="ratingsReviews" class="block px-3 py-3 hover:bg-[#2E1B8C] rounded-md font-semibold text-lg transition-colors">Ratings and Reviews</a>
      <a href="#" id="userQueries" class="block px-3 py-3 bg-[#2E1B8C] rounded-md font-semibold text-lg transition-colors">User Queries</a>
      <a href="/src/admin/features/feature-facilities/feature-facilities.html" id="featuresFacilities" class="block px-3 py-3 hover:bg-[#2E1B8C] rounded-md font-semibold text-lg transition-colors">Features & Facilities</a>
      <a href="/src/admin/features/backup-recovery/backup-recovery.html" class="block px-3 py-3 hover:bg-[#2E1B8C] rounded-md font-semibold text-lg transition-colors">Backup & Restore</a>
      <a href="/src/admin/features/content-management/content-management.html" id="settings" class="block px-3 py-3 hover:bg-[#2E1B8C] rounded-md font-semibold text-lg transition-colors">Content Management</a>
    </nav>

    <div class="p-4 border-t border-[#2E1B8C] relative">
      <div class="flex items-center space-x-3 cursor-pointer hover:bg-[#2E1B8C] rounded-lg p-2 transition-colors duration-200">
        <a href="#" onclick="logout()" class="flex items-center px-4 py-2 rounded-lg shadow-sm hover:drop-shadow-md text-white-600 ">
          <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" clip-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z"/></svg>
          <span class="font-medium text-basex">Logout</span>
        </a>
      </div>
    </div>
  </aside>

  <!-- Query Details Modal -->
  <section>
    <div id="queryModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-hidden">
        <header class="p-6 border-b border-gray-200 bg-gray-50">
          <div class="flex items-center justify-between">
            <h2 id="queryModalTitle" class="text-xl font-semibold text-gray-800">Query Details</h2>
            <button id="closeQueryModal" class="text-gray-400 hover:text-gray-600 transition-colors">
              <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </header>

        <div class="p-6 overflow-y-auto max-h-[calc(90vh-120px)]">
          <div class="space-y-6">
            <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Customer Name</label>
                <p id="modalUserName" class="text-lg font-semibold text-gray-900 bg-gray-50 p-3 rounded-md"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                <p id="modalEmail" class="text-lg text-gray-900 bg-gray-50 p-3 rounded-md"></p>
              </div>
            </section>

            <section class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Query Date</label>
                <p id="modalDate" class="text-lg text-gray-900 bg-blue-50 p-3 rounded-md border-l-4 border-primary"></p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">Subject</label>
                <p id="modalSubject" class="text-lg text-gray-900 bg-gray-50 p-3 rounded-md"></p>
              </div>
            </section>

            <section>
              <label class="block text-sm font-medium text-gray-700 mb-3">Query Description</label>
              <div class="bg-gray-50 border border-gray-200 rounded-lg p-4">
                <p id="modalDescription" class="text-gray-800 leading-relaxed whitespace-pre-wrap"></p>
              </div>
            </section>

            <section>
              <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
              <span id="modalStatus" class="inline-flex px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800">Unread</span>
            </section>
          </div>
        </div>

        <footer class="p-6 border-t border-gray-200 bg-gray-50 flex justify-end gap-3">
          <button id="closeQueryModalBtn" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">Close</button>
          <button id="markReadFromModal" class="px-4 py-2 bg-accent text-white rounded-md hover:bg-accent transition-colors">Mark as Read</button>
          <button id="deleteQueryFromModal" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Delete Query</button>
        </footer>
      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section id="mainContent" class="min-h-screen transition-all duration-300 lg:ml-80">
    <main id="mainContentArea" class="p-4 sm:p-4 lg:p-8 mt-4 sm:mt-6 lg:mt-0">
      <header class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-8 transition-all duration-300">
        <div>
          <h1 class="text-3xl sm:text-3xl lg:text-4xl font-bold text-gray-800 transition-all duration-300 leading-tight">User Queries Management</h1>
          <div class="h-1 w-24 bg-primary rounded-full mt-2"></div>
        </div>
        <section class="flex items-center gap-3">
          <button id="markAllReadBtn" class="flex items-center gap-2 px-6 py-3 border border-primary rounded-lg hover:bg-primary hover:text-white transition-all duration-200 font-medium text-sm text-primary professional-shadow hover:professional-shadow-lg">
            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg>
            <span>Mark All as Read</span>
          </button>
          <button id="deleteAllBtn" class="flex items-center gap-2 px-6 py-3 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all duration-200 font-medium text-sm professional-shadow hover:professional-shadow-lg">
            <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
            <span>Delete All</span>
          </button>
        </section>
      </header>

      <!-- Statistics Cards -->
      <section class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl professional-shadow border border-gray-200 p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Total Queries</p>
              <p id="totalQueriesCount" class="text-2xl font-bold text-gray-900">0</p>
            </div>
            <div class="p-3 bg-blue-50 rounded-full">
              <svg class="w-6 h-6 text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl professional-shadow border border-gray-200 p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Unread Queries</p>
              <p id="unreadQueriesCount" class="text-2xl font-bold text-yellow-600">0</p>
            </div>
            <div class="p-3 bg-yellow-100 rounded-full">
              <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            </div>
          </div>
        </div>
        <div class="bg-white rounded-xl professional-shadow border border-gray-200 p-6">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Read Queries</p>
              <p id="readQueriesCount" class="text-2xl font-bold text-accent">0</p>
            </div>
            <div class="p-3 bg-green-100 rounded-full">
              <svg class="w-6 h-6 text-accent" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
          </div>
        </div>
      </section>

      <!-- Loading Indicator -->
      <div id="loadingIndicator" class="flex justify-center items-center py-12 bg-white border-t border-gray-100 hidden" role="status" aria-label="Loading User Queries">
        <l-dot-spinner size="40" speed="0.9" color="#2563EB"></l-dot-spinner>
        <span class="ml-3 text-gray-600 font-medium">Loading user queries...</span>
      </div>

      <!-- Queries Table -->
      <section id="tableContainer" class="bg-white rounded-xl professional-shadow-lg border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-professional-gradient text-white">
              <tr>
                <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">#</th>
                <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">User Name</th>
                <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">Email</th>
                <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">Date</th>
                <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">Subject</th>
                <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">Description</th>
                <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">Status</th>
                <th class="px-6 py-4 text-left text-xs font-semibold uppercase tracking-wider">Action</th>
              </tr>
            </thead>
            <tbody id="tableBody" class="bg-white divide-y divide-gray-100"></tbody>
          </table>
        </div>

        <!-- No Data Message -->
        <div id="noDataMessage" class="bg-white p-12 text-center hidden" role="status">
          <div class="text-gray-500">
            <svg class="mx-auto h-16 w-16 text-gray-300 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>
            <h3 class="text-lg font-medium text-gray-800 mb-2">No user queries found</h3>
            <p class="text-gray-500">There are no user queries to display at this time.</p>
          </div>
        </div>

        <!-- Pagination -->
        <div id="paginationContainer" class="bg-gray-50 border-t border-gray-200 px-6 py-5">
          <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
            

            <div class="flex items-center gap-2 text-sm">
              <label for="itemsPerPage" class="text-gray-600 font-medium">Items per page:</label>
              <select id="itemsPerPage" class="border border-gray-300 rounded-md px-3 py-2 text-gray-700 font-medium focus:ring-2 focus:ring-primary focus:border-primary bg-white professional-shadow">
                <option value="10" selected>10</option>
                <option value="25">25</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>

            <div class="flex items-center gap-3">
              <button id="prevPage" class="pagination-button flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:border-primary hover:text-primary disabled:opacity-40 disabled:cursor-not-allowed bg-white font-medium" aria-label="Previous page">
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
                </svg>
                <span>Previous</span>
              </button>

              <div class="flex items-center gap-2 text-sm text-gray-600 px-4">
                <span>Page</span>
                <span id="currentPageNumber" class="font-semibold text-primary">0</span>
                <span>of</span>
                <span id="totalPages" class="font-semibold text-primary">0</span>
              </div>

              <button id="nextPage" class="pagination-button flex items-center gap-2 px-4 py-2 rounded-lg border border-gray-300 text-gray-600 hover:border-primary hover:text-primary disabled:opacity-40 disabled:cursor-not-allowed bg-white font-medium" aria-label="Next page">
                <span>Next</span>
                <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                  <path fill-rule="evenodd" d="M7.293 14.707a1 1 0 010-1.414L10.586 10 7.293 6.707a1 1 0 011.414-1.414l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414 0z" clip-rule="evenodd" />
                </svg>
              </button>
            </div>
          </div>
        </div>
      </section>
    </main>
  </section>

  <script>
    // -----------------------
    // API and State
    // -----------------------
    const API_BASE = 'https://68c8b85aceef5a150f622643.mockapi.io';
    const QUERIES_ENDPOINT = `${API_BASE}/admin/9`;

    let userQueriesData = [];
    let filteredData = [];
    let currentQueryId = null;

    // -----------------------
    // DOM References
    // -----------------------
    const loadingIndicator = document.getElementById('loadingIndicator');
    const tableContainer  = document.getElementById('tableContainer');
    const tableBody       = document.getElementById('tableBody');
    const noDataMessage   = document.getElementById('noDataMessage');

    const totalQueriesCount  = document.getElementById('totalQueriesCount');
    const unreadQueriesCount = document.getElementById('unreadQueriesCount');
    const readQueriesCount   = document.getElementById('readQueriesCount');

    const prevBtn         = document.getElementById('prevPage');
    const nextBtn         = document.getElementById('nextPage');
    const itemsPerPageSel = document.getElementById('itemsPerPage');

   
    const currentPageEl   = document.getElementById('currentPageNumber');
    const totalPagesEl    = document.getElementById('totalPages');

    // -----------------------
    // Utilities
    // -----------------------
    function showLoading(show) {
      if (!loadingIndicator || !tableContainer) return;
      if (show) {
        loadingIndicator.classList.remove('hidden');
        const table = tableContainer.querySelector('table');
        if (table) table.style.display = 'none';
        noDataMessage?.classList.add('hidden');
      } else {
        loadingIndicator.classList.add('hidden');
        const table = tableContainer.querySelector('table');
        if (table) table.style.display = 'table';
      }
    }

    function showError(message) { console.error('Error:', message); alert(message); }
    function showInfo(message)  { console.log('Info:', message); alert(message); }
    function showSuccess(msg)   {
      const toast = document.createElement('div');
      toast.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300';
      toast.textContent = msg;
      document.body.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => document.body.removeChild(toast), 300); }, 2500);
    }

    function escapeHtml(text) {
      if (typeof text !== 'string') return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDate(dateString) {
      try {
        const d = new Date(dateString);
        return d.toLocaleDateString('en-US', { year:'numeric', month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
      } catch { return 'Invalid Date'; }
    }

    // -----------------------
    // Generic Pager (filteredData slice)
    // -----------------------
    const pagerState = {
      currentPage: 1,
      itemsPerPage: parseInt(itemsPerPageSel?.value || '10', 10),
    };

    function updateButtonStyles(button, disabled) {
      if (!button) return;
      button.disabled = disabled;
      if (disabled) {
        button.classList.add('opacity-40','cursor-not-allowed');
        button.classList.remove('hover:border-primary','hover:text-primary');
      } else {
        button.classList.remove('opacity-40','cursor-not-allowed');
        button.classList.add('hover:border-primary','hover:text-primary');
      }
    }

    function updatePaginationUI() {
      const totalItems = filteredData.length;
      const totalPages = Math.max(1, Math.ceil(totalItems / pagerState.itemsPerPage) || 1);
      pagerState.currentPage = Math.min(Math.max(1, pagerState.currentPage), totalPages);

      const start = totalItems > 0 ? (pagerState.currentPage - 1) * pagerState.itemsPerPage + 1 : 0;
      const end   = totalItems > 0 ? Math.min(pagerState.currentPage * pagerState.itemsPerPage, totalItems) : 0;

   
      if (currentPageEl)  currentPageEl.textContent = totalItems > 0 ? pagerState.currentPage : 0;
      if (totalPagesEl)   totalPagesEl.textContent  = totalItems > 0 ? Math.ceil(totalItems / pagerState.itemsPerPage) : 0;

      const disablePrev = pagerState.currentPage <= 1 || totalItems === 0;
      const disableNext = pagerState.currentPage >= Math.ceil(totalItems / pagerState.itemsPerPage) || totalItems === 0;
      updateButtonStyles(prevBtn, disablePrev);
      updateButtonStyles(nextBtn, disableNext);

      if (tableContainer && noDataMessage) {
        if (totalItems === 0) {
          noDataMessage.classList.remove('hidden');
          tableContainer.classList.add('hidden');
        } else {
          noDataMessage.classList.add('hidden');
          tableContainer.classList.remove('hidden');
        }
      }
    }

    function getPageSlice() {
      const startIndex = (pagerState.currentPage - 1) * pagerState.itemsPerPage;
      const endIndex   = startIndex + pagerState.itemsPerPage;
      return filteredData.slice(startIndex, endIndex);
    }

    // -----------------------
    // Rendering
    // -----------------------
    function renderQueriesPage(pageData) {
      if (!tableBody) return;
      tableBody.innerHTML = '';
      pageData.forEach((query) => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50 transition-colors';

        const userName    = query.userName || query.name || 'Unknown User';
        const email       = query.email || query.Email || 'No email provided';
        const date        = formatDate(query.date || query.createdAt || new Date().toISOString());
        const subject     = query.subject || query.Subject || 'No subject';
        const description = query.description || query.message || 'No description';
        const isRead      = !!query.read;
        const status      = isRead ? 'Read' : 'Unread';
        const statusClass = isRead ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800';

        row.innerHTML = `
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${query.id}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHtml(userName)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${escapeHtml(email)}</td>
          <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${date}</td>
          <td class="px-6 py-4 text-sm text-gray-600 max-w-xs">
            <p class="line-clamp-2" title="${escapeHtml(subject)}">${escapeHtml(subject)}</p>
          </td>
          <td class="px-6 py-4 text-sm text-gray-600 max-w-xs">
            <p class="line-clamp-2" title="${escapeHtml(description)}">${escapeHtml(description)}</p>
          </td>
          <td class="px-6 py-4 whitespace-nowrap">
            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${status}</span>
          </td>
          <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
            <div class="flex gap-2">
              <button class="text-blue-600 hover:text-blue-900 p-2 rounded transition-colors view-btn" title="View Details" data-id="${query.id}">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.477 0 8.268 2.943 9.542 7-1.274 4.057-5.065 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>
              </button>
              ${!isRead ? `
              <button class="text-green-600 hover:text-green-900 p-2 rounded transition-colors mark-read-btn" title="Mark as Read" data-id="${query.id}">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
              </button>` : ''}
              <button class="text-red-600 hover:text-red-900 p-2 rounded transition-colors delete-btn" title="Delete Query" data-id="${query.id}">
                <svg class="h-4 w-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
              </button>
            </div>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function renderCurrentPage() {
      updatePaginationUI();
      const pageSlice = getPageSlice();
      renderQueriesPage(pageSlice);
    }

    // -----------------------
    // Stats
    // -----------------------
    function updateStatistics() {
      const total  = userQueriesData.length;
      const unread = userQueriesData.filter(q => !q.read).length;
      const read   = userQueriesData.filter(q => q.read).length;
      if (totalQueriesCount)  totalQueriesCount.textContent  = total;
      if (unreadQueriesCount) unreadQueriesCount.textContent = unread;
      if (readQueriesCount)   readQueriesCount.textContent   = read;
    }

    // -----------------------
    // API interactions
    // -----------------------
    async function fetchUserQueries() {
      try {
        showLoading(true);
        const res = await fetch(QUERIES_ENDPOINT);
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        const data = await res.json();
        // Normalize: accept array or object with array prop
        if (Array.isArray(data)) return data;
        if (data && Array.isArray(data.UserQueries)) return data.UserQueries;
        if (data && Array.isArray(data.userQueries)) return data.userQueries;
        const arrayProp = data && typeof data === 'object' ? Object.values(data).find(v => Array.isArray(v)) : null;
        return arrayProp || [];
      } catch (err) {
        showError('Failed to load user queries. Please try again later.');
        return [];
      } finally {
        showLoading(false);
      }
    }

    async function updateApiData(updatedArray) {
      // PUT back into the same resource with expected wrapper shape
      const body = JSON.stringify({ id: 9, UserQueries: updatedArray });
      const res = await fetch(QUERIES_ENDPOINT, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body
      });
      if (!res.ok) throw new Error(`Failed to update data: ${res.status} ${res.statusText}`);
      return res.json();
    }

    async function deleteQueryFromApi(id) {
      try {
        const numericId = parseInt(id, 10);
        if (!Number.isFinite(numericId)) { showError('Invalid query ID'); return false; }
        const exists = userQueriesData.some(q => parseInt(q.id, 10) === numericId);
        if (!exists) { showError('Query not found'); return false; }
        showLoading(true);
        const updated = userQueriesData.filter(q => parseInt(q.id, 10) !== numericId);
        await updateApiData(updated);
        userQueriesData = updated;
        filteredData = [...userQueriesData];
        updateStatistics();
        pagerState.currentPage = 1; // reset after delete for clarity
        renderCurrentPage();
        showSuccess('Query deleted successfully');
        return true;
      } catch (e) {
        showError('Failed to delete query. Please try again.');
        return false;
      } finally {
        showLoading(false);
      }
    }

    async function markQueriesAsReadInApi(ids = []) {
      try {
        const idSet = new Set(ids.map(n => parseInt(n, 10)));
        const updated = userQueriesData.map(q => {
          const qid = parseInt(q.id, 10);
          if (ids.length === 0 || idSet.has(qid)) return { ...q, read: true };
          return q;
        });
        try { await updateApiData(updated); } catch { /* local update anyway */ }
        userQueriesData = updated;
        filteredData = [...userQueriesData];
        updateStatistics();
        renderCurrentPage();
        showSuccess(ids.length <= 1 ? 'Query marked as read' : `${ids.length} queries marked as read`);
        return true;
      } catch {
        showError('Failed to mark queries as read. Please try again.');
        return false;
      }
    }

    // -----------------------
    // Modal
    // -----------------------
    const queryModal = document.getElementById('queryModal');
    const closeQueryModal = document.getElementById('closeQueryModal');
    const closeQueryModalBtn = document.getElementById('closeQueryModalBtn');
    const deleteQueryFromModal = document.getElementById('deleteQueryFromModal');
    const markReadFromModal = document.getElementById('markReadFromModal');

    function openQueryModal(queryId) {
      const q = userQueriesData.find(x => String(x.id) === String(queryId));
      if (!q) { showError('Query not found'); return; }
      currentQueryId = String(queryId);
      const modalMap = {
        modalUserName: q.userName || q.name || 'Unknown User',
        modalEmail: q.email || q.Email || 'No email provided',
        modalDate: formatDate(q.date || q.createdAt || new Date().toISOString()),
        modalSubject: q.subject || q.Subject || 'No subject',
        modalDescription: q.description || q.message || 'No description provided'
      };
      Object.entries(modalMap).forEach(([id, val]) => {
        const el = document.getElementById(id);
        if (el) el.textContent = val;
      });
      const modalStatus = document.getElementById('modalStatus');
      if (modalStatus) {
        const isRead = !!q.read;
        modalStatus.textContent = isRead ? 'Read' : 'Unread';
        modalStatus.className = isRead
          ? 'inline-flex px-3 py-1 rounded-full text-sm font-medium bg-green-100 text-green-800'
          : 'inline-flex px-3 py-1 rounded-full text-sm font-medium bg-yellow-100 text-yellow-800';
      }
      queryModal?.classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    }

    function closeModal() {
      queryModal?.classList.add('hidden');
      document.body.style.overflow = 'auto';
      currentQueryId = null;
    }

    // -----------------------
    // Event wiring
    // -----------------------
    document.addEventListener('DOMContentLoaded', async () => {
      // Load queries
      userQueriesData = await fetchUserQueries();
      filteredData = [...userQueriesData];
      updateStatistics();
      pagerState.currentPage = 1;
      renderCurrentPage();

      // Pagination controls
      prevBtn?.addEventListener('click', (e) => {
        if (e.currentTarget.disabled) return;
        pagerState.currentPage -= 1;
        renderCurrentPage();
      });
      nextBtn?.addEventListener('click', (e) => {
        if (e.currentTarget.disabled) return;
        pagerState.currentPage += 1;
        renderCurrentPage();
      });
      itemsPerPageSel?.addEventListener('change', (e) => {
        const val = parseInt(e.target.value, 10);
        pagerState.itemsPerPage = Number.isFinite(val) && val > 0 ? val : 10;
        pagerState.currentPage = 1;
        renderCurrentPage();
      });

      // Header bulk actions
      document.getElementById('markAllReadBtn')?.addEventListener('click', async () => {
        const ids = filteredData.filter(q => !q.read).map(q => parseInt(q.id, 10));
        if (ids.length === 0) { showInfo('No unread queries to mark as read.'); return; }
        if (confirm(`Mark all ${ids.length} unread queries as read?`)) {
          await markQueriesAsReadInApi(ids);
        }
      });
      document.getElementById('deleteAllBtn')?.addEventListener('click', async () => {
        if (filteredData.length === 0) { showInfo('No queries to delete.'); return; }
        if (!confirm(`Delete all ${filteredData.length} visible queries? This cannot be undone.`)) return;
        try {
          showLoading(true);
          const remaining = userQueriesData.filter(q => !filteredData.some(fq => String(fq.id) === String(q.id)));
          await updateApiData(remaining);
          userQueriesData = remaining;
          filteredData = [];
          updateStatistics();
          pagerState.currentPage = 1;
          renderCurrentPage();
          showSuccess('All queries deleted successfully');
        } catch {
          showError('Failed to delete all queries. Please try again.');
        } finally {
          showLoading(false);
        }
      });

      // Modal events
      closeQueryModal?.addEventListener('click', closeModal);
      closeQueryModalBtn?.addEventListener('click', closeModal);
      queryModal?.addEventListener('click', (e) => { if (e.target === queryModal) closeModal(); });

      deleteQueryFromModal?.addEventListener('click', async () => {
        if (!currentQueryId) return;
        if (confirm('Delete this query? This action cannot be undone.')) {
          const ok = await deleteQueryFromApi(currentQueryId);
          if (ok) closeModal();
        }
      });
      markReadFromModal?.addEventListener('click', async () => {
        if (!currentQueryId) return;
        await markQueriesAsReadInApi([parseInt(currentQueryId, 10)]);
        closeModal();
      });

      // Row actions via delegation
      tableBody?.addEventListener('click', async (event) => {
        const btn = event.target.closest('button');
        if (!btn) return;
        const id = btn.getAttribute('data-id');
        if (!id) return;
        if (btn.classList.contains('view-btn')) {
          openQueryModal(id);
        } else if (btn.classList.contains('mark-read-btn')) {
          await markQueriesAsReadInApi([parseInt(id, 10)]);
        } else if (btn.classList.contains('delete-btn')) {
          if (confirm('Are you sure you want to delete this query? This action cannot be undone.')) {
            await deleteQueryFromApi(id);
          }
        }
      });

      // Keyboard: close modal with Escape
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && queryModal && !queryModal.classList.contains('hidden')) closeModal();
      });
    });
  </script>

  <!-- Remove external queries.js to avoid double rendering; keep sidebar.js if needed -->
  <!-- <script src="queries.js"></script> -->
  <script src="sidebar.js"></script>
</body>
</html>
